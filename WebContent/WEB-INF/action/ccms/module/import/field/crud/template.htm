<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>导入字段映射信息</title>
</head>
<body>
	<div class="panel panel-default col_mainInner">
		<div class="panel-heading col_main_body_title text-center">
			<h2 class="panel-title">导入字段映射信息</h2>
		</div>
		<div class="panel-body col_main_body">
			<form class="form-horizontal" role="form" method="post"
				id="searchForm" name="searchForm">
				<input name="sort" type="hidden" value="tuid" preserve="true" /> <input
					name="order" type="hidden" value="desc" preserve="true" /> <input
					name="pageNo" type="hidden" value="" preserve="true" /> <input
					name="totalPages" type="hidden" value="" preserve="true" /> <input
					type="hidden" name="subject_id" id="subject_id" value="" />
				<div class="form-group">
					<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
						<div class="col-xs-8 col-sm-7 col-md-7 col-lg-7">
							<input class="form-control" id="field_code_filter"
								name="field_code_filter" type="text" size="35" value=""
								placeholder="请输入字段代码" /> <input id="tab_id_filter"
								name="tab_id_filter" type="hidden" size="35" value=""
								preserve="true" />
						</div>
						<button type="button" id="search_btn"
							class="btn btn-primary btn-md">查询</button>
						<button type="button" id="search_reset_btn"
							class="btn btn-primary btn-md">重置</button>
						<button class="btn btn-primary btn-md" type="button"
							id="addnew_btn">新增</button>
					</div>
				</div>
			</form>
			<table class="table table-bordered">
				<thead>
					<tr>
						<th>操作</th>
						<th class="sortable" code="field_code">字段代码</th>
						<th class="sortable" code="field_name">字段名</th>
						<th class="sortable" code="col_name">电子表格列名</th>
						<th class="sortable" code="update_mode">更新标识</th>
						<th class="sortable" code="field_type">字段类型</th>
						<th class="sortable" code="field_length">字段长度</th>
						<th class="sortable" code="is_mandatory">是否非空标识</th>
						<th class="sortable" code="show_align">预览时水平对齐类型</th>
						<th class="sortable" code="show_order">字段顺序</th>
						<th class="sortable" code="is_virtual_type">是否虚拟字段</th>
						<th class="sortable" code="is_formula">是否为公式</th>
						<th class="sortable" code="is_save_code">是否保存代码值</th>
						<th class="sortable" code="default_value">默认值</th>
						<th class="sortable" code="domain_namespace">命名空间名称</th>
						<th class="sortable" code="fk_tab">外键关联表代码</th>
						<th class="sortable" code="fk_fld_name">外键关联字段名</th>
					</tr>
				</thead>
				<tbody id="datagridTemplate" style="display: none">
					<tr>

						<td align="center">
							<button class="btn btn-primary btn-md edit_btn" type="button"
								code="#tuid#">修改</button>
							<button class="btn btn-primary btn-md delete_btn" type="button"
							code="#tuid#">删除</button>
						</td>
						<td align="center">#field_code#</td>
						<td align="center">#field_name#</td>
						<td align="center">#col_name#</td>
						<td align="center">#update_mode#</td>
						<td align="center">#field_type#</td>
						<td align="center">#field_length#</td>
						<td align="center">#is_mandatory#</td>
						<td align="center">#show_align#</td>
						<td align="center">#show_order#</td>
						<td align="center">#is_virtual_type#</td>
						<td align="center">#is_formula#</td>
						<td align="center">#is_save_code#</td>
						<td align="center">#default_value#</td>
						<td align="center">#domain_namespace#</td>
						<td align="center">#fk_tab#</td>
						<td align="center">#fk_fld_name#</td>
					</tr>
				</tbody>
				<tbody id="datagrid">
				</tbody>
			</table>
			<div class="pageDiv">
				<ul class="pagination">
				</ul>
			</div>
		</div>
	</div>

	<div class="modal fade" id="modalAddnew" tabindex="-1" role="dialog">
		<div class="modal-dialog modal-lg">
			<div class="modal-content ">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">&times;</button>
					<h4 class="modal-title" id="formTitle">导入字段映射信息</h4>
				</div>
				<div class="modal-body">
					<form class="form-horizontal" role="form" method="post"
						id="formEditor" name="formEditor">
						<input name="subject_id" type="hidden" value="${fld:subject_id}"
							preserve="true" /> <input type="hidden" id="tuid" name="tuid"
							value="" />
						<div class="row clearfix">
							<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1 required">字段代码</label>
									<div class="col-xs-6 col-sm-5 col-md-5 col-lg-5">
										<input type="hidden" id="tab_id" name="tab_id" value=""
											maxlength="200" preserve="true" /> <input
											class="form-control" type="text" id="field_code"
											name="field_code" value="" readonly maxlength="128" />
									</div>
									<img src="${def:context}/images/search.gif"
										style="cursor: pointer;" id="pick1" title="查询表名" /> <img
										src="${def:context}/images/clear.gif" style="cursor: pointer;"
										id="pickClear1" title="清除选择的内容" />
								</div>
								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1 ">电子表格列名</label>
									<div class="col-xs-8 col-sm-7 col-md-7 col-lg-7">
										<input class="form-control" type="text" id="col_name"
											name="col_name" value="" maxlength="128" />
									</div>
								</div>
								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1 required">字段类型</label>
									<div class="col-xs-6 col-sm-5 col-md-5 col-lg-5">
										<input id="field_type" name="field_type" value="varchar"
											type="hidden" /> <input class="form-control" id="type_alias"
											name="type_alias" readonly="" class="readonly" type="text" />
									</div>
									<img src="${def:context}/images/search.gif"
										style="cursor: pointer;" id="pick2" title="查询字段类型" /> <img
										src="${def:context}/images/clear.gif" style="cursor: pointer;"
										id="pickClear2" title="清除选择的内容" />
								</div>
								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1 required">字段长度</label>
									<div class="col-xs-8 col-sm-7 col-md-7 col-lg-7">
										<input class="form-control" type="text" id="field_length"
											name="field_length" value="" maxlength="12" />
									</div>
								</div>
								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1">命名空间名称</label>
									<div class="col-xs-8 col-sm-7 col-md-7 col-lg-7">
										<input class="form-control" type="text" id="domain_namespace"
											name="domain_namespace" value="" maxlength="64" />
									</div>
								</div>

								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1 ">默认值</label>
									<div class="col-xs-8 col-sm-7 col-md-7 col-lg-7">
										<input class="form-control" type="text" id="default_value"
											name="default_value" value="" maxlength="256" />
									</div>
								</div>
								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1 ">外键schema</label>
									<div class="col-xs-6 col-sm-5 col-md-5 col-lg-5">
										<input class="form-control" type="text" id="fk_schema"
											name="fk_schema" value="" readonly maxlength="64" /> <input
											type="hidden" id="fk_schema_hidden" name="fk_schema_hidden"
											value="" />
									</div>
									<img src="${def:context}/images/search.gif"
										style="cursor: pointer;" id="pick3" title="查询字段类型" /> <img
										src="${def:context}/images/clear.gif" style="cursor: pointer;"
										id="pickClear3" title="清除选择的内容" />
								</div>
								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1 ">外键关联表代码</label>
									<div class="col-xs-6 col-sm-5 col-md-5 col-lg-5">
										<input class="form-control" type="text" id="fk_tab"
											name="fk_tab" value="" maxlength="64" /> <input type="hidden"
											id="fk_tab_hidden" name="fk_tab_hidden" />
									</div>
									<img src="${def:context}/images/search.gif"
										style="cursor: pointer;" id="pick4" title="查询外键关联表代码" />
								</div>
								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1 ">外键关联字段代码</label>
									<div class="col-xs-6 col-sm-5 col-md-5 col-lg-5">
										<input class="form-control" type="text" id="fk_fld_code" name="fk_fld_code" value="" maxlength="64" /> 
										<input type="hidden" id="fk_fld_code_hidden" name="fk_fld_code_hidden" />
									</div>
									<img src="${def:context}/images/search.gif"
										style="cursor: pointer;" id="pick5" title="查询外键关联字段代码" />

								</div>
								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1 ">外键关联字段名</label>
									<div class="col-xs-8 col-sm-7 col-md-7 col-lg-7">
										<input class="form-control" type="text" id="fk_fld_name"
											name="fk_fld_name" value="" maxlength="64" />
									</div>
								</div>
								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1 ">字段顺序</label>
									<div class="col-xs-8 col-sm-7 col-md-7 col-lg-7">
										<input class="form-control" type="text" id="show_order"
											name="show_order" value="" maxlength="32" />
									</div>
								</div>
							</div>
							<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1 required">字段ID</label>
									<div class="col-xs-8 col-sm-7 col-md-7 col-lg-7">
										<input class="form-control" type="text" id="field_id" name="field_id" value="" maxlength="200" />
									</div>
								</div>
								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1 required">更新标识</label>
									<div class="col-xs-8 col-sm-7 col-md-7 col-lg-7">
										<input type="radio" id="update_mode" name="update_mode"	value="0">不更新</input> 
										<input type="radio" id="update_mode" name="update_mode" value="1">覆盖更新</input> 
										<input type="radio" id="update_mode" name="update_mode" value="2">原值为空更新</input>
										<input type="radio" id="update_mode" name="update_mode" value="3">追加更新</input>
									</div>
								</div>
								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1 required">是否非空标识</label>
									<div class="col-xs-8 col-sm-7 col-md-7 col-lg-7">
										<input type="radio" name="is_mandatory" id="is_mandatory"
											value="0">否</input> <input type="radio" name="is_mandatory"
											id="is_mandatory" value="1">是</input>
									</div>
								</div>
								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1 required">是否为虚拟字段</label>
									<div class="col-xs-8 col-sm-7 col-md-7 col-lg-7">
										<input type="radio" name="is_virtual_type"
											id="is_virtual_type" value="0">否</input> <input type="radio"
											name="is_virtual_type" id="is_virtual_type" value="1">是</input>
									</div>
								</div>

								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1 required">默认值是否为公式</label>
									<div class="col-xs-8 col-sm-7 col-md-7 col-lg-7">
										<input type="radio" name="is_formula" id="is_formula"
											value="0">否</input> <input type="radio" name="is_formula"
											id="is_formula" value="1">是</input>
									</div>
								</div>
								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1 required">是否保存代码值</label>
									<div class="col-xs-8 col-sm-7 col-md-7 col-lg-7">
										<input type="radio" name="is_save_code" id="is_save_code"
											value="0">否</input> <input type="radio" name="is_save_code"
											id="is_save_code" value="1">是</input>
									</div>
								</div>
								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1 ">正则表达式校验</label>
									<div class="col-xs-8 col-sm-7 col-md-7 col-lg-7">
										<input class="form-control" type="text" id="regex_rule"
											name="regex_rule" value="" maxlength="128" />
									</div>
								</div>
								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1 ">数据预览时水平对齐类型</label>
									<div class="col-xs-8 col-sm-7 col-md-7 col-lg-7">
										<select class="form-control" name="show_align" id="show_align">
											<option value="left">左对齐</option>
											<option value="center">居中对齐</option>
											<option value="right">右对齐</option>
										</select>
									</div>
								</div>

								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1 ">正则表达式校验失败提示</label>
									<div class="col-xs-8 col-sm-7 col-md-7 col-lg-7">
										<input class="form-control" type="text" id="regex_tip"
											name="regex_tip" value="" maxlength="128" />
									</div>
								</div>

								<div class="form-group">
									<label
										class="col-xs-2 col-sm-3 col-md-3 col-lg-3 control-label col-xs-offset-1 col-sm-offset-1 col-md-offset-1 col-lg-offset-1 ">备注</label>
									<div class="col-xs-8 col-sm-7 col-md-7 col-lg-7">
										<input class="form-control" type="text" id="remark"
											name="remark" value="" maxlength="128" />
									</div>
								</div>
							</div>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<div
						class="col-xs-12 col-sm-8 col-md-6 col-lg-8 col-xs-offset-1 col-sm-offset-2 col-md-offset-3 col-lg-offset-2">
						<button type="button" id="save_btn" class="btn btn-primary btn-md">确&nbsp;定</button>
						<button type="button" class="btn btn-primary btn-md"
							data-dismiss="modal">取&nbsp;消</button>
					</div>
				</div>
			</div>
		</div>
	</div>


	<!--用于传递当前目录到header模版中-->
<input type="hidden" name="actionroot" id="actionroot" value="${def:actionroot}">

<script language="javascript">
    $(document).ready(function () {
    	$("#tab_id_filter").val("${fld:tab_id}");
    	$("#tab_id").val("${fld:tab_id}");
    	var search=null;
        var obj = $Crud({
            formId: "formEditor",
            button: "save_btn",
            insertBack: function () {
            	$(".error").empty();
            	search.searchData();
            },
            updateBack: function () {
            	search.searchData();
            },
            deleteBack: function () {
            	search.searchData();
            },
            addNewBack: function () {
                $("#formTitle").html("新增导入字段映射信息");
                setCheckboxValue("update_mode","0","formEditor");
            	setCheckboxValue("is_virtual_type","0","formEditor");
            	setCheckboxValue("is_mandatory","0","formEditor");
            	setCheckboxValue("is_formula","0","formEditor");
            	setCheckboxValue("is_save_code","1","formEditor");
            },
            editBack: function () {
                $("#formTitle").html("修改导入字段映射信息");
            },
            validate: function () {
                var flag = $("#formEditor").validate({
                    rules: {
                    	field_code: {
                            required: true
                        },
                        field_id: {
                            required: true
                        },
                        type_alias: {
                            required: true
                        },
                        field_length: {
                            required: true
                        },
                        update_mode: {
                            required: true
                        },
                        is_mandatory: {
                            required: true
                        },
                        is_virtual_type: {
                            required: true
                        },
                        is_formula: {
                            required: true
                        },
                        is_save_code: {
                            required: true
                        }
                    },
                    messages: {
                    	field_code: {
                            required: "值不能为空"
                        },
                        field_id: {
                            required: "值不能为空"
                        },
                        type_alias: {
                            required: "值不能为空"
                        },
                        field_length: {
                            required: "值不能为空"
                        },	
                        update_mode: {
                            required: "值不能为空"
                        },
                        is_mandatory: {
                            required: "值不能为空"
                        },
                        is_virtual_type: {
                            required: "值不能为空"
                        },
                        is_formula: {
                            required: "值不能为空"
                        },
                        is_save_code: {
                            required: "值不能为空"
                        }
                    }
                });
                return flag;
            },
            check:function(){
            	var field_length_value = document.getElementById("field_length").value;
            	var default_value_value = document.getElementById("default_value").value;
            	//默认值长度不能大于字段长度
            	if(!isNaN(field_length_value)){
            		if(default_value_value!=""){
            			if(default_value_value.length > parseInt(field_length_value)){
            				$Dialog().alert("默认值长度不能大于字段长度");
            				return false;
            			}
            		}
            	}
            	var fk_schema_value = document.getElementById("fk_schema").value;
            	var fk_tab_value = document.getElementById("fk_tab").value;
            	var fk_fld_code_value = document.getElementById("fk_fld_code").value;
            	var fk_fld_name_value = document.getElementById("fk_fld_name").value;
            	//外键四个字段都为空或都不为空
            	if(fk_schema_value==""&&fk_tab_value==""&&fk_fld_code_value==""&&fk_fld_name_value==""||
            			fk_schema_value!=""&&fk_tab_value!=""&&fk_fld_code_value!=""&&fk_fld_name_value!=""){
            	}else{
            		$Dialog().alert("外键schema、外键关联表代码、外键关联字段代码、外键关联字段名  都为空或都不为空");
            		return false;
            	}
            	var domain_namespace = document.getElementById("domain_namespace").value;
            	var is_save_code = GetRadioValue("is_save_code","formEditor");
            	if(is_save_code == "0"){
            		if(domain_namespace != "" || fk_tab_value != ""){
            			$Dialog().alert("当前字段有namespace或者外键表关联，字段“是否保存代码值”只能选择是！");
            			return false;
            		}
            	}
            	var regex_rule = document.getElementById("regex_rule").value;
            	var regex_tip = document.getElementById("regex_tip").value;
            	var field_type = document.getElementById("field_type").value;
            	if(regex_rule != ""){
            		if(field_type.toLowerCase() != "varchar"){
            			$Dialog().alert("正则表达式校验只适应于类型为字符串的字段！");
            			return false;
            		}
            		if(domain_namespace != "" || fk_tab_value != ""){
            			$Dialog().alert("正则表达式校验不能作用于namespace或者外键表关联的字段！");
            			return false;
            		}
            		if(regex_tip == ""){
            			$Dialog().alert("正则表达式校验失败提示不能为空！");
            			return false;
            		}
            	}
                return true;
    		}
        }).init();

        search=$Search({datagrid: "datagrid", formId: "searchForm", success: function () {
            $(".edit_btn").unbind().on("click", function () {
                if ($(this).attr("code") != undefined && $(this).attr("code") != "") {
                    obj.edit({id: $(this).attr("code")});
                }
            });
            $(".delete_btn").unbind().on("click", function () {
                var obthis = $(this);
                $Dialog().confirm("确定要删除该条数据吗?", function () {
                    if (obthis.attr("code") != undefined && obthis.attr("code") != "") {
                        obj.del({id: obthis.attr("code")});
                    }
                });
            });
            
        	//字段代码选取框
    		$("#pick1").unbind().on("click",function(){
    			var url = "${def:context}/action/ccms/module/import/field/pick/crud?tab_id="+"${fld:tab_id}";
    			ccms.dialog.open({url:url,id:"pickOpen",width:800,height:600});
    		});
    		$("#pickClear1").unbind().on("click",function(){
    			document.getElementById("field_id").value='';
    			document.getElementById("field_code").value='';
    			document.getElementById("field_length").value='';
    			document.getElementById("default_value").value='';
    			document.getElementById("domain_namespace").value='';
    			document.getElementById("field_type").value='';
    			document.getElementById("type_alias").value='';
    			document.getElementById("show_order").value='';
    			document.getElementById("fk_schema").value='';
    			document.getElementById("fk_tab").value='';
    			document.getElementById("fk_fld_id").value='';
    		});
    		
		   	 //字段类型选取框
    		$("#pick2").unbind().on("click",function(){
    			var url = "${def:context}/action/ccms/pub/pick/fieldtype?pickId=pickOpen&id=field_type&name=type_alias";
    			ccms.dialog.open({url:url,id:"pickOpen",width:800,height:600});
    		});
    		$("#pickClear2").unbind().on("click",function(){
    			document.getElementById("field_type").value='';
    			document.getElementById("type_alias").value='';
    		});
				
	   	 	 //外键schema选取框
	   		$("#pick3").unbind().on("click",function(){
	   			var url = "${def:context}/action/ccms/pub/pick/db_schema?pickId=pickOpen&id=fk_schema_hidden&name=fk_schema";
	   			ccms.dialog.open({url:url,id:"pickOpen",width:800,height:600});
	   		});
	   		$("#pickClear3").unbind().on("click",function(){
	   			document.getElementById("fk_schema").value='';
	   			document.getElementById("fk_schema_hidden").value='';
	   			document.getElementById("fk_tab").value='';
	   			document.getElementById("fk_tab_hidden").value='';
	  		});
	   		
	   		//外键关联表代码选取框
	   		$("#pick4").unbind().on("click",function(){
	   			var schema = document.formEditor.fk_schema.value;
		       	if (schema!=""){
	   			var url = "${def:context}/action/ccms/pub/pick/db_table?pickId=pickOpen&id=fk_tab_hidden&name=fk_tab&schema="+ schema;
	   			ccms.dialog.open({url:url,id:"pickOpen",width:800,height:600});
		       	}
	   		});
	   		
	  		//外键关联字段代码选取框
	   		$("#pick5").unbind().on("click",function(){
	   			var schema = document.formEditor.fk_schema.value;
		      	var table = document.formEditor.fk_tab.value;
		     	if (schema!=""&&table!=""){
	   			var url = "${def:context}/action/ccms/pub/pick/db_column?pickId=pickOpen&id=fk_fld_code_hidden&name=fk_fld_code&schema="+ schema+"&table="+table;
	   			ccms.dialog.open({url:url,id:"pickOpen",width:800,height:600});
		       	}
	   		});
        }}).initSearchBtn().searchData(1);
    });
</script>

</body>
</html>

