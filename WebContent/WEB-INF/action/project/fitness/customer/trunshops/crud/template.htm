<!DOCTYPE html>
<html lang="zh-CN">
<head>
<!--${inc:/action/project/fitness/home/pub} -->
<title>会员转店</title>
 <link href="${def:context}/js/project/fitness/css/contract1.css" rel="stylesheet">
<style type="text/css">
.bg{
background: rgba(42, 48, 56, -1.2) !important
}

</style>
</head>
    <body style="font-size: 14px">
	<form id="ptrestForm" name="ptrestForm" class="form-horizontal" role="form" method="post">
		<input type="hidden" id="type" value="1" />
				<div class="am-tabs r-tab-container goodsSale">
					<div class="sec-1">
						<input type="text" name="custall" id="custall" title="会员编号/姓名/手机号" placeholder="会员编号/姓名/手机号" style="width: 160px;" />
						<input type="hidden" name="custcode" id="custcode" /> 
						<button type="button" id="querybtn">查询</button>
					</div>
					<div class="sec-2">
						<div class="sec-top">
							<label for="depot">通店：</label>
							<div class="my-selected" >
								<select id="org_id" name="org_id" style="display: none;">
									<org-rows>
										<option value="${fld:org_id}">${fld:org_name}</option>
									</org-rows>
								</select>
							</div>
							<label for="depot">转店会籍：</label>
							<div class="my-selected" >
								<select id="turnclasspt" name="turnclasspt" style="display: none;">
									<option value="">全部会籍</option>
									<pt-rows>
										<option value="${fld:userlogin}">${fld:name}</option>
									</pt-rows>
								</select>
							</div>
							<button type="button" id="trunbtn">转店</button>
						</div>
						<div class="sec-bottom r-tab-cout-3-b">
							<table>
								<thead>
									<tr>
										<th>序号</th>
										<th>卡号</th>
										<th>姓名</th>
										<th>合同编号</th>
										<th>合同类型</th>
										<th>卡类型</th>
										<th>转店后卡类型</th>
										<th>卡状态</th>
										<th>销售员</th>
										<th>有效期</th>
									</tr>
								</thead>
								<tbody id="cardrestlist">
								</tbody>
							</table>
							<table>
								<thead>
									<tr>
										<th>序号</th>
										<th>私教类型</th>
										<th>私练</th>
										<th>转店后课程</th>
										<th>转店后私练</th>
										<th>总课时</th>
										<th>剩余课时</th>
										<th>有效期</th>
										<th>来源</th>
									</tr>
								</thead>
								
								<tbody id="ptrestlist">
									
								</tbody>
							</table>
						</div>
					</div>
					<div class="sec-4">
						<label>操作员：</label>
						<input id="czy" type="text"  value="${fld:staff_name}" readonly="readonly">
						<label>操作日期：</label>
						<input type="text" value="${def:date}" readonly="readonly">
					</div>
				</div>
     </form>
     <form class="form-horizonta" role="form" method="post" id="updateform"
		name="updateform" >
		<input id="customercode" name="customercode"  type="hidden"/>
		<input id="createdby" name="createdby"  type="hidden"/>
		<input id="mcid" name="mcid"  type="hidden"/>
		<input id="orgcode" name="orgcode"  type="hidden"/>
		<div id="gcode">
		</div>
	</form>
    </body>
<script type="text/javascript">
var bin="";
$(function(){
	searchSelectInit($("#turnclasspt,#org_id"));
	setSelectValue($("#org_id"), "${def:org}");
	//查询会员
	$("#querybtn").click(function(){
		if($("#custall").val()==""){
			ccms.dialog.notice("请输入会员编号/姓名/手机号！", 2000);
			return false;
		}
		var custall=$("#custall").val();
		$("#type").val("1");
		if(custall!=""){
			ccms.dialog.open({url : "${def:context}/action/project/fitness/customer/trunshops/trunshop/crud?pickcustname="
					+custall+"&org_id=${def:org}&objid=custcode&objidtwo=custall&random_number="+Math.random()});
		}else{
			$("#cardrestlist").html("");
			$("#ptrestlist").html("");
			$("#custcode").val("");
		}
	});
	
});

function pickcardCallback(){
	if($("#type").val()=="1"){
		var url = "${def:actionroot}/querycardrest?custcode="+$("#custcode").val()+"&org_id="+$("#org_id").val();
		ajaxCall(url,{
			method:"get",
			progress:true,
			dataType:"script",
			success:function(){	
				 for(i=1;i<=cardcount;i++){
					var yuan = $("#yuan"+i).val();
					
					if(yuan==1){
						$("#xiancardname"+i).html($("#jicitd"+i).html());
						$("#jicitd"+i).remove();
					}else{
						$("#xiancardname"+i).html($("#shixiaotd"+i).html());
						$("#shixiaotd"+i).remove();
					} 
				} 
			}
		});
		
	}
}


function pickcustCallback(){
	if($("#type").val()=="1"){
		var url = "${def:actionroot}/queryptrest?custcode="+$("#custcode").val()+
		"&org_id="+$("#org_id").val();
		ajaxCall(url,{
			method:"get",
			progress:true,
			dataType:"script",
			success:function(){	
			}
		});
	}
	
}





		


document.onkeydown=function(event){
    var e = event || window.event || arguments.callee.caller.arguments[0];
	if(e && e.keyCode==13){ // enter 键
		$("#querybtn").click();
	 	return false;

	}
}



$("#trunbtn").unbind().on("click",function(){
	if($("#custall").val()==""){
		ccms.dialog.notice("请输入会员编号/姓名/手机号！", 2000);
	}else if($("#org_id").val()=="${def:org}"){
		ccms.dialog.notice("已在本店,请选择要转的店！", 2000);
	}else if($("#turnclasspt").val()==""||""==$("#turnclasspt").val()){
		ccms.dialog.notice("请选择会籍！", 2000);
	} else{
		var bin="";
		var ben="";
		var codes="";
		var prids="";
		var cardtypelist="";
		var ptjsons="[";
		 var mcjsons="[";
		    var sts="";
		    var yuan = "";
		    var xian="";
		    var cardcodelist="";
		    for (var j = 1; j <= cardcount; j++) { 
				yuan=$("#yuan"+j).val();
		    	if(j!=cardcount){
		    		
		    		cardcodelist+=$("#cardcode"+j).text();
		    		cardcodelist+=(",");
		    		if(yuan==1){
		    			cardtypelist +=$("#"+"jici"+j).val();
			    		cardtypelist +=(",");
			    		xian=$("#"+"jici"+j).val();
		    		}else {
		    			cardtypelist +=$("#"+"shixiao"+j).val();
			    		cardtypelist +=(",");
			    		xian=$("#"+"shixiao"+j).val();
		    		}
		    		mcjsons+="{"+'"concode":'+'"'+$("#"+"htcode"+j).val()+'"'+","+ '"yuanmc":' +'"'+$("#"+"salemember"+j).val()+'"' +","+'"xianmc":'+'"'+$("#turnclasspt").val()+'"'
		    		+","+'"cardcode":'+'"'+$("#cardcode"+j).text()+'"'+","+'"yuancardtypeid":'+'"'+$("#cardtypecode"+j).val()+'"'+","+'"xiancardtypeid":'+'"'+xian+'"'+"},";
		    	}else{
		    		cardcodelist+=$("#cardcode"+j).text();
		    		if(yuan==1){
		    			cardtypelist +=$("#"+"jici"+j).val();
		    			xian=$("#"+"jici"+j).val();
		    		}else {
		    			cardtypelist +=$("#"+"shixiao"+j).val();
		    			xian=$("#"+"shixiao"+j).val();
		    		}
		    		mcjsons+="{"+'"concode":'+'"'+$("#"+"htcode"+j).val()+'"'+","+ '"yuanmc":' +'"'+$("#"+"salemember"+j).val()+'"' +","+'"xianmc":'+'"'+$("#turnclasspt").val()+'"'+
		    		","+'"cardcode":'+'"'+$("#cardcode"+j).text()+'"'+","+'"yuancardtypeid":'+'"'+$("#cardtypecode"+j).val()+'"'+","+'"xiancardtypeid":'+'"'+xian+'"'+"}]";
		    	}
		    	
		   	}
		    var relatedetails="";
			    for (var i = 1; i <= count; i++) { 
			    	if(i!=count){
			    		bin +=$("#"+"course"+i).val();
			    		bin +=(",");
			    		ben +=$("#"+"jiao"+i).val();
			    		ben +=(",")
			    		codes +=$("#"+"ids"+i).val();
			    		codes +=(",");
			    		relatedetails +=$("#relatedetailyi"+i).val() +";"+$("#"+"course"+i).val()+";"+
			    		$("#relatedetailsan"+i).val()+";"+
			    		$("#relatedetailsi"+i).val()+";"+
			    		$("#relatedetailwu"+i).val()+";"+
			    		$("#relatedetailliu"+i).val()+";"+
			    		$("#relatedetailqi"+i).val()+";"+
			    		$("#turnclasspt").val()+";"+
			    		$("#"+"jiao"+i).val()+";"+
			    		$("#jiao"+i).find("option:selected").text()+";"+
			    		$("#relatedetailshiyi"+i).val()+";"+
			    		$("#relatedetailshier"+i).val()+";"+
			    		$("#relatedetailshisan"+i).val()+";"+
			    		$("#relatedetailshisi"+i).val()+";";
			    		relatedetails +=(",");
			    		ptjsons+="{"+'"code":'+'"'+$("#"+"prid"+i).val()+'"'+","+ '"yuankc":' +'"'+$("#"+"ptlevelcode"+i).val()+'"' +","+'"xiankc":'+'"'+$("#"+"course"+i).val()+'"'+
			    			","+'"yuanpt":'+'"'+$("#"+"ypid"+i).val()+'"'+","+'"xianpt":'+'"'+$("#"+"jiao"+i).val()+'"'+"},";
			    	}else{
			    		bin +=$("#"+"course"+i).val();
			    		ben +=$("#"+"jiao"+i).val();
			    		relatedetails +=$("#relatedetailyi"+i).val() +";"+$("#"+"course"+i).val()+";"+
			    		$("#relatedetailsan"+i).val()+";"+
			    		$("#relatedetailsi"+i).val()+";"+
			    		$("#relatedetailwu"+i).val()+";"+
			    		$("#relatedetailliu"+i).val()+";"+
			    		$("#relatedetailqi"+i).val()+";"+
			    		$("#turnclasspt").val()+";"+
			    		$("#"+"jiao"+i).val()+";"+
			    		$("#jiao"+i).find("option:selected").text()+";"+
			    		$("#relatedetailshiyi"+i).val()+";"+
			    		$("#relatedetailshier"+i).val()+";"+
			    		$("#relatedetailshisan"+i).val()+";"+
			    		$("#relatedetailshisi"+i).val()+";";
			    		codes +=$("#"+"ids"+i).val();
			    		ptjsons+="{"+'"code":'+'"'+$("#"+"prid"+i).val()+'"'+","+ '"yuankc":' +'"'+$("#"+"ptlevelcode"+i).val()+'"' +","+'"xiankc":'+'"'+$("#"+"course"+i).val()+'"'+
		    			","+'"yuanpt":'+'"'+$("#"+"ypid"+i).val()+'"'+","+'"xianpt":'+'"'+$("#"+"jiao"+i).val()+'"'+"}]";
			    	}
			    	
			   	}
			   
			    var orgjsons="[{"+'"yuanorgid":'+'"'+"${def:org}"+'"'+","+'"xianorgid":'+'"'+$("#org_id").val()+'"'+"}]";
			    $("#orgcode").val($("#org_id").val());
			    $("#mcid").val($("#turnclasspt").val());
			    $("#customercode").val($("#custcode").val());
			    $("#createdby").val($("#czy").val());
			    
			    var ids=codes.split(",");
			    var cardtypes=cardtypelist.split(",");
			    var courseids=bin.split(",");
			    var ptids=ben.split(",");
			    var orgid=$("#org_id").val();
			    var divobj = $("#gcode");
			    var cardcodes=cardcodelist.split(",");
			    var cardorgid=$("#org_id").val();
			    var relatedetailss=relatedetails.split(",");
			    divobj.empty();
			    for(var s = 0; s < cardcodes.length; s++){
					var cardcode = cardcodes[s];
					var cardtypeid=cardtypes[s];
			    	divobj.append('<input type="hidden" name="cardcode" value="' + cardcode + '" />');
			    	divobj.append('<input type="hidden" name="cardtypeid" value="' + cardtypeid + '" />');
			    	divobj.append('<input type="hidden" name="cardorgid" value="' + cardorgid + '" />');
			    }
			    var courseid="";
			    var ptid="";
			    var yz="";
			    
			    if(count!=0){
				    for(var b = 0; b < ptids.length; b++){
				    	yz = ptids[b];
						if(yz=="null"||yz==""){
							ccms.dialog.notice("请选择教练！", 2000);
							return false;
						} 
						
					} 
			    }
			    if(count==0&&cardcount==0){
			    	ccms.dialog.notice("该会员卡已过期！", 2000);
			    	return false;
			    }
			    if(yz!="null"){
			    	  for(var v = 0; v < ids.length; v++){
							var codeid = ids[v];
							courseid = courseids[v];
							ptid = ptids[v];
							var relatedetail= relatedetailss[v];
					    	divobj.append('<input type="hidden" name="courseid" value="' + courseid + '" />');
					    	divobj.append('<input type="hidden" name="ptid" value="' + ptid + '" />');
							divobj.append('<input type="hidden" name="orgid" value="' + orgid + '" />');
					    	divobj.append('<input type="hidden" name="codeid" value="' + codeid + '" />');
					    	divobj.append('<input type="hidden" name="relatedetail" value="' + relatedetail + '" />');
						}
					    divobj.append('<input type="hidden"  name="ptjsons" value='+ptjsons+' />');
					    divobj.append('<input type="hidden"  name="mcjsons" value=' + mcjsons + ' />');
					    divobj.append('<input type="hidden"  name="orgjsons" value=' + orgjsons + ' />');

					    $Dialog().confirm("确定要转店吗？",function(){
							var url = "${def:context}${def:actionroot}/zhuandian";
							ajaxCall(url,{
						   		method: "post",
						   		form:"updateform",
						   		progress: true,
						   		dataType: "script",
						   		success: function() {
								  url3="${def:context}${def:actionroot}/crud";
						   			 $Dialog().notice("转店成功！",1000,function(){
						   				document.location.reload();	
									}); 
								  
						   		}
							});
						});
			    }
			  
		 }
	
});

</script>
</html>
