<!DOCTYPE html>
<html>
<head>
${inc:/action/project/fitness/home/pub}
<title>入场刷卡</title>
</head>
<style>
.rccx{
    text-align: left;
    width: 102%;
    line-height: 40px;
    height: 40px;
    padding-left: 20px;
    /* background: #f0f0f0; */
    background: #213540;
    color: #fff;
    margin-top: -14px;
    }
    .rcsk button.btn-default-36 {
    margin: 0 3px !important;
}
</style>
<body>
	 <form  role="form" method="post" id="searchForm" name="searchForm">
		<input id="unionorgid" name="unionorgid" type="hidden" />
		<input id="cust_name" name="cust_name" type="hidden" />
		<input id="cust_code" name="cust_code" type="hidden" />
		<input id="cardtype" name="cardtype" type="hidden" />
		<input id="cpcode" name="cpcode" type="hidden" />
		<input id="nowcount" name="nowcount" type="hidden" />
		<input id="checkedcard" name="checkedcard" type="hidden" />
		<!-- 卡时间段限制，判断是否能入场 -->
		<input id="cardtypetimelimit" name="cardtypetimelimit" type="hidden" />
		<!-- 时间段限制，不能入场提示什么时间段可入场 -->
		<input id="cardtypetimelimitstr" name="cardtypetimelimitstr" type="hidden" />
		<!-- 1会员卡入场  2体验卡入场 -->
		<input id="inlefttype" name="inlefttype" type="hidden" />
		<div class="am-tabs-bd r-tab-cont rcsk">
			<div class="rc-tab-cout-1 am-tab-panel am-in am-active am-fade three-none" >
				<div class="tab-cout-nav">
					<div class="tab-cout-nav-t">
						<nav class="tab-nav-my">
							<li class="input-default-li">
								<input id="custall"  name="custall" class="input-default" type="text" placeholder="请输入会员卡号/姓名/手机号等">
							</li>
							
							<button type="button" class="r-c-3-btn-1" id="search_card" title="查询"></button>
							
							<li class="label-p changeWidth">
								<select id="weather" name="weather" class="selectpicker">
									<option value="">全部天气</option>
									<weather-list>
										<option value="${fld:param_value}">${fld:param_text}</option>
									</weather-list>
								</select>
							</li>
							
							<li class="label-p">
								<label for="rc-n-1-2">手牌号：</label>
								<input class="input-default" type="text"  id="rudge_code" name="rudge_code"  placeholder="请输入手牌号">
							</li>
							
							<button type="button" class="refurbish btn-default-36" id="clearform" title="清空"></button>
							<button type="button" class="toDo btn-default-36" id="execution" title="执行">执行</button>
							<button type="button" class="toSay btn-default-36">读取设备</button>
							<button type="button" class="toDo btn-default-36" id="detailcustinfo" title="查看">详情</button>
						</nav>
					</div>
				</div>
				
				<div class="rc-bottom" id="searchhtml" style="display: none;">
					<section class="rc-b-left">
						<header>会员基本信息</header>
						<div>
							<p class="img-outer">
								<img id="headpic" src="${def:context}/js/project/fitness/image/SVG/170X220.svg" alt="">
								<button type="button" id="upload_btn"></button>
							</p>
								<nav>
									<li>
										<p>会员卡号</p> 
										<span id="custcodeone"></span>
									</li>
									<li>
										<p>卡类型</p> 
										<span id="cardtype_name"></span>
									</li>
									<li>
										<p>姓名</p> 
										<span id="name"></span>
									</li>
									<li>
										<p>电话</p> 
										<span id="mobile"></span>
									</li>
									<li>
										<p>手牌号</p> 
										<span id="cabinettempcode"></span>
									</li>
									<li>
										<p>会籍顾问</p> 
										<span id="mc"></span>
									</li>
								</nav>
							</div>
					</section>
					
					<section class="rc-b-right">
						<div class="r-tab-cout-3-b">
							<div class="to-change-background">会员卡选择</div>
								<table class="">
									<thead>
										<tr>
											<th></th>
											<th>会员卡名称</th>
											<th>有效期至</th>
											<th>支持门店</th>
											<th>本次入场扣除次数</th>
											<th>卡状态</th>
										</tr>
									</thead>
									<tbody id="cardlist">
									</tbody>
								</table>
						</div>
						
						<div class="r-tab-cout-3-b">
							<div class="to-change-background">私教</div>
							<table class="">
								<thead>
									<tr>				
										<th>课程</th>
										<th>教练</th>
										<th>总课时</th>
										<th>总剩余</th>
									</tr>
								</thead>
								<tbody id="custptrest">
								</tbody>
							</table>
						</div>
						
						<div class="r-tab-cout-3-b">
							<div class="to-change-background">私教约课信息</div>
							<table class="">
								<thead>
									<tr>				
										<th>课程名称</th>
										<th>教练</th>
										<th>预约课时</th>
										<th>剩余课时</th>
										<th>预约时间</th>
										<th>预约人</th>
									</tr>
								</thead>
								<tbody id="custptprepare">
								</tbody>
							</table>
						</div>
						
						<div class="r-tab-cout-3-b" id="tuancao">
							<div class="to-change-background">团操选择</div>
							<table class="">
								<thead>
									<tr>
										<th></th>
										<th>团操名称</th>
										<th>开课时间</th>
										<th>操厅</th>
										<th>教练</th>
									</tr>
								</thead>
								<tbody id="classdef">
								</tbody>
							</table>
						</div>
						<div class="rc-b-r-footer">
							<header>刷卡提示</header>
							<span style="color: red;" cols="30" rows="4">
								<span style="color: red;" id="errorinfo"></span>
							</span>
						</div>
					</section>
				</div>
			</div>
		</div>
	</form> 
	<form role="form" method="post" id="searchForm1">
        <input name="sort" type="hidden" value="indate;intime" preserve="true" />
		<input name="order" type="hidden" value="desc;desc" preserve="true" />
		<input name="pageNo" type="hidden" value="" preserve="true" />
		<input name="totalPages" type="hidden" value="" preserve="true" />
		<!--间隔 -->
		<div class="r-tab-cont" style="    margin-top: 100px;">
			<div class="c-n-nav-2 am-tab-panel am-in am-active am-fade three-none" >
			
				<div class="r-tab-cout-3-t">
					<div class="rccx"> 今日入场</div>
					<div class="r-tab-cout-3-t-t">
				
						<nav>
						  	<li class="inputNametwo">
								<input id="vc_cardcode" name="vc_cardcode" type="text" placeholder="会员卡号/姓名/手机号" class="input-default" />
						   </li>
							<li class="inputNametwo">
								<input id="vc_tempcabinet" name="vc_tempcabinet" type="text" placeholder="手牌号" class="input-default" />
							</li>
							<div>
								<button type="button" class="r-c-3-btn-1" id="search_btn" title="查询"></button>
							</div>
						</nav>
					</div>
				</div>				
			</div>
			<div class="r-tab-cout-3-b">
				<div class="to-change-background"></div>
					<table class="" id="table">
						<thead>
							<tr>
							    <th>卡号</th>				
								<th>卡类型</th>
							    <th>姓名</th>		
							    <th>手牌号</th>
								<th>会籍</th>
							    <th>入场日期</th>
							    <th>签到人数</th>
							    <th>入场时间</th>
								<th>离场时间</th>
							    <th>在场时间</th>
							    <th>截止日期</th>
							</tr>
						</thead>
						<tbody id="datagridTemplate" style="display:none">
							<tr>	
				                <td>#vc_cardcode#</td>		
				                <td>#vc_type#</td>	
				                <td>#name#</td>
		 					    <td>#vc_tempcabinet#</td>
				                <td>#vc_inusername#</td>				
				                <td>#c_initime#</td>		
				                <td>#signednumber#</td>
				                <td>#c_initime_time#</td>
				                <td>#lefttime#</td>
				        		<td>#presencedate#</td>
				        		<td>#enddate#</td>
							</tr>
						</tbody>
						<tbody id="datagrid">
						</tbody>
					</table>
				<div class="pageDiv">
					<ul class="pagination">
					</ul>
				</div>
			</div>
		</div>
	</form>
<input type="hidden" name="actionroot" id="actionroot" value="${def:actionroot}" />
<script type="text/javaScript">
var searchinleft = null;
$(document).ready(function() {
	//入场查询
	this.searchinleft=searchinleft;
	searchinleft=$Search({datagrid:"datagrid",formId:"searchForm1",
		rowpackage : function(obj) {
			var datetime = dateReduce(new Date(obj.jsintime), new Date(obj.jslefttime));
			if(datetime==""&&obj.lefttime!=""){
				datetime = "1分钟";
			}
			obj.presencedate = datetime;
		},success:function(){
			$("#vc_cardcode,#vc_tempcabinet").val("");
	}}).initSearchBtn().searchData(1);
	//查询输入框设置焦点
	$("#custall").focus();
	//加载当天天气
	<weatherinfo-list>
		$("#weather").val('${fld:weather}');
	</weatherinfo-list>

	selectInit($("#weather"));
	
	// 上传头像
	$("#upload_btn").unbind().on("click",function(){
		var pkvalue = $("#cust_code").val();
		if( "" == pkvalue ){
			ccms.dialog.notice("请获取会员信息后再上传头像", 2000);
		}else{
			ccms.dialog.open({url: contextPath+"/action/project/fitness/util/attachment/photo/crud?table_code=cc_customer&pk_value="+pkvalue, height: "600", width: "630"});
		}
	});
	//页面点击事件
	 $(document).click(function(){ 
		$(".error").html("");
		$("#errorinfo").html("暂无数据");
	 }); 
	//查询会员卡信息
	$("#search_card").click(function(){
		//查询入场记录
		//$("#search_btn").click();
		$("#custcodeone,#cardtype_name,#name,#mobile,#cabinettempcode,#mc").html("");
		var custall = $("#custall").val();
		custall = custall.replace(/\s+/g,"");
		$("#searchhtml").hide();
		if(custall==""){
			ccms.dialog.notice("请输入会员卡号/姓名/手机号！", 2000);
		}else{
			var memberhead = "${fld:memberhead}";
			var findcust = custall.substring(0,memberhead.length+1);
			//相等查询体验卡相反正常查询 
			if(("T"+memberhead)==findcust){
				$("#inlefttype").val("2");
				$("#upload_btn,#tuancao").hide();
				$("#errorinfo,#classdef,#cardlist").html("");
				var classdefurl="${def:context}${def:actionroot}/queryexpercardlist?code="+custall;
				search(classdefurl);
			}else{
				$("#inlefttype").val("1");
				$("#upload_btn,#tuancao").show();
				var classdefurl="${def:context}${def:actionroot}/querycardnum?custall="+custall;
				search(classdefurl);
			}
		}
	});
	//查看会员明细
	$("#detailcustinfo").click(function(){
		if($("#cust_code").val()==""){
			ccms.dialog.notice("请输入会员信息并查询后执行该操作！", 3000);
			return false;
		}
		ccms.dialog.open({url : '${def:context}/action/project/fitness/guest/follow/custcomm?cust_type=1&type=1&commtype='
				+1+'&customercode='+$("#cust_code").val()+"&status=1",width:1200,height:700});
	});
	//天气修改
	$("#weather").change(function(){
		var weather = $(this).val();
		if(weather!=""){
			var url = "${def:context}${def:actionroot}/weather?weather="+weather;
			ajaxCall(url,{
				method : "get",
				progress : false,
				dataType : "script",
				success : function() {
				}
			});
		}
	})
	//清空手牌，查询条件
	$("#clearform").click(function(){
		$("#rudge_code,#custall").val("");
		$("#searchhtml").hide();
		ccms.util.clearForm("searchForm");
		$("#custall").focus();
	});
	//执行
	$("#execution").click(function(){
		if($("#custall").val()==""){
			ccms.dialog.notice("请输入会员卡号/姓名/手机号", 2000);
			return false;
		}
		//会员卡code
		var val = getCheckboxValue("cardcode");
		var cpcode = getCheckboxValue("classprepare");
		if(val==""){
			$("#errorinfo").html("请选择会员卡！");
		}else{
			//跟进后台设置判断是否需要输入手牌
			if("${fld:ishand}"=="1"){
				//判断手牌是否为空
				if($("#rudge_code").val()==""){
					//手牌为空提示输入手牌，将手牌号文本框设置焦点
					ccms.dialog.notice("请输入手牌！", 2000, function(){
						$("#rudge_code").focus();
					});
					return false;
				}
			}
			//判断卡状态是否可以入场
			var cardstatus = $('input:radio[name="cardcode"]:checked').attr("cardstatus");
			if(cardstatus=="2"){
				ccms.dialog.notice("该卡不能入场，请确认！", 2000);
				return false;
			}
			var codetype=$('input:radio[name="cardcode"]:checked').attr("code1");
			var code=$('input:radio[name="cardcode"]:checked').attr("code");
			var code2=$('input:radio[name="cardcode"]:checked').attr("code2");
			var code3=$('input:radio[name="cardcode"]:checked').attr("code3");
			$("#cardcode").val(val);
			$("#cardtype").val(code);
			$("#cpcode").val(cpcode);
			if(code2=="1"){$("#nowcount").val($("#"+val+"num").val());}else{$("#nowcount").val("");}
			var url="${def:context}${def:actionroot}/update";
			//入场判断时间段限制条件
			if(codetype=="2"){
				//查询该卡时间段限制，判断该时间段是否能入场
				ajaxCall("${def:context}${def:actionroot}/querywhetheradmission?cardtype="+code+"&org_id="+code3,{
					method:"get",
					dataType:"script",
					success:function(data){
						var cardtypetimelimit = parseInt($("#cardtypetimelimit").val());
						//判断该卡类型该时间段是否能入场
						if(cardtypetimelimit==0){
							ccms.dialog.notice("该卡现时间段不能入场！入场时间为：<br/>"+$("#cardtypetimelimitstr").val());
							return false;
						}else{
							postsubmit(url);
						}
					}
				})
			}else{
				postsubmit(url);
			}
		}
	});
});
function search(url){
	ajaxCall(url,{
		method:"GET",
		progress:true,
		dataType:"script",
		success:function(){
		}
	});
}
function postsubmit(url){
	ajaxCall(url,{
		method:"post",
		form:"searchForm",
		progress:true,
		dataType:"script",
		success:function(){
		}
	});
}
//回调查询方法
function pickcustCallback(){
	var url="${def:context}${def:actionroot}/searchcard?custall="+$("#cust_code").val()+"&unionorgid="
			+$("#unionorgid").val()+"&checkedcard="+$("#checkedcard").val();
	search(url);
	var classdefurl="${def:context}${def:actionroot}/searchclassprepare?custall="+$("#cust_code").val()+"&unionorgid="+$("#unionorgid").val();
	search(classdefurl);
	var classdefurl="${def:context}${def:actionroot}/queryptrest?custall="+$("#cust_code").val()+"&unionorgid="+$("#unionorgid").val();
	search(classdefurl);
	var classdefurl="${def:context}${def:actionroot}/queryptprepare?customercode="+$("#cust_code").val()+"&unionorgid="+$("#unionorgid").val();
	search(classdefurl);
	$("#searchhtml").show();
}
//回车事件
  var isRunning   = [];
document.onkeydown=function(event){
    var e = event || window.event || arguments.callee.caller.arguments[0];
	if(e && e.keyCode==13){ // enter 键
		$("#search_card").click();
	 	return false;
    }else if(e && e.keyCode==37){ // 上下左右    左
		$("#clearform").click();
	 	return false;
    }else if(e && e.keyCode==38){ // 上下左右    上
    }else if(e && e.keyCode==39){ // 上下左右    右
    	//刷卡
    	$("#execution").click();
     	return false;
    }else if(e && e.keyCode==40){ // 上下左右    下
    	//查询会员明细
    	$("#detailcustinfo").click();
     	return false;
    }
}; 
//未查询到会员卡信息关闭查询弹框并查询input焦点
function closefindcard(){
	ccms.dialog.close("rc1001");
	$("#custall").focus();
}
</script>
</body>
</html> 