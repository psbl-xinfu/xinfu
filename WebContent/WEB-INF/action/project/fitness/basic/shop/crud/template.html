<!DOCTYPE html>
<html lang="zh-CN">
<head>
${inc:/action/project/fitness/home/pub}
<title>商品销售</title>
<link href="${def:context}/js/project/fitness/css/contract1.css" rel="stylesheet">
<style type="text/css">
.bg{
background: rgba(42, 48, 56, -1.2) !important
}
.top-table{
    margin-top: 13px;
	width:100%;
	height:220px;
	overflow:auto;
}
.goodsSale .sec-1 .btn-save {
    width: 47px;
    background-image: url(${def:context}/js/project/fitness/image/SVG/nav/fukuan.svg);
}
</style>
</head>
    <body style="font-size: 14px">
	<form id="goodsForm" name="goodsForm" class="form-horizontal" role="form" method="post">
		<input type="hidden" name="findtype" id="findtype"/>
				<div class="am-tabs r-tab-container goodsSale">
					<div class="sec-1">
						<label for="id">编号：</label>
						<input type="text" name="leave_stockid" readonly="readonly" id="leave_stockid" value="${fld:leave_stockid}" title="编号" placeholder="编号" />
						<input type="hidden" name="searchgptuid" id="searchgptuid"/>
						<label for="id">状态：</label>
						<label class="status">未支付</label>
						<span class="fr sec-btn btn-save" id="save_btn" title="购买" style="display: none;"></span>
					</div>
					<div class="sec-2" style="height: 300px;">
						<div class="sec-top">
							<label for="depot">当前仓库：</label>
							<div class="my-selected" >
								<select id="storage_id" name="storage_id" style="display: none;">
									<option value="">全部仓库</option>
									<storage-rows>
										<option value="${fld:tuid}">${fld:storage_name}</option>
									</storage-rows>
								</select>
							</div>
							<label for="name">商品：</label>
							<select id="goodsname" name="goodsname" class="select-btn" style="position: static!important;display: none!important;">
								<option value="">全部商品</option>
							</select>
							<!-- <input type="text" id="goodsname" name="goodsname" title="名称/货号" placeholder="名称/货号" /> -->
							<label for="total">合计：</label>
							<input type="hidden" id="ystotal" name="ystotal" />
							<input type="text" id="total" name="total" class="total" readonly="readonly" value="0" title="合计" placeholder="合计" />
							<span class="fr sec-btn btn-remove" title="删除"></span>
						</div>
						<div class="sec-bottom r-tab-cout-3-b top-table">
							<table>
								<thead>
									<tr>
										<th class="table-checkbox">
											<input type="checkbox" id="selectAll" style="display: none;">
										</th>
										<th>序号</th>
										<th>品名</th>
										<th>规格</th>
										<th>单位</th>
										<th>单价</th>
										<th>数量</th>
										<th>折扣(%)</th>
										<th>实收金额</th>
									</tr>
								</thead>
								<tbody id="goodslist">
								</tbody>
							</table>
						</div>
					</div>
					<div class="sec-3">
						<div class="sec-3-left fl" style="height: 263px">
							<div class="sec-3-left-title">			
								<label class="am-checkbox">
									<input type="hidden" value="0" id="staff_type" />
									<input type="checkbox" value="1" id="staff_price" name="staff_price" style="display: none;">员工价
								</label>
							</div>
							<div class="form-control bg" style="border: none;">
								<div class="cont-div">
									<label class="cont-label">卡号：</label>
									<input type="text" id="cardcode" name="cardcode" title="卡号" placeholder="卡号">
									<input type="hidden" id="drinkdiscount" name="drinkdiscount" value="1">
								</div>
								<div class="cont-div">
									<label class="cont-label">手机号：</label>
									<input type="text" id="mobile" title="手机号" placeholder="手机号" readonly="readonly">
									<input type="hidden" id="custcode" name="custcode">
								</div>
								<div class="cont-div">
									<label class="cont-label">姓名：</label>
									<input type="text" id="custname" title="姓名" placeholder="姓名" readonly="readonly">
								</div>
							</div>
						</div>
						<div class="sec-3-right fl">
							<label class="sec-3-right-title">付款方式</label>
							<div class="sec-3-right-con">
								<div class="top">
									<label class="am-checkbox">
										<input type="radio" name="othertype" value="2" checked="checked" style="display: none;">储值卡支付
									</label>
									
									<input type="radio" name="othermoney" value="1" checked="checked" style="display: none;">现金储值
									<input id="moneycash" name="moneycash"  type="text" title="现金储值" placeholder="现金储值" readonly="readonly">
							
									<input type="radio" name="othermoney" value="2" style="display: none;margin-top: 20px">运动基金
									<input id="moneygift" name="moneygift"type="text" title="运动基金" placeholder="运动基金" readonly="readonly"> 
								</div>
							
								<div class="bottom  ">
									<input type="hidden" name="pay_detail" id="pay_detail">
									<label class="am-checkbox">
										<input type="radio" name="othertype" value="1" style="display: none;">其他支付方式
									</label>
								
									<div class="my-selected" style="margin-top: 5px">
										<select placeholder='请选择支付方式' id="moneytype" name="moneytype" style="display: none;">
											<option value="">支付方式</option>
											<OtherPayWay-rows>
												<option value="${fld:cnfg_id}">${fld:content}</option>
											</OtherPayWay-rows>
										</select>
									</div>
									
									<div class="form-control bg" style="width:300px ;border: none;">
										<div class="cont-div" style="width:1000px ;">
											<label class="cont-label" style="width: 50px;float: left;margin-top: 7px">金额：</label>
											<input type="text" id="money" name="money" title="金额" placeholder="金额" style="margin-top: -3px;width: 15%;float: left;margin-left: -0px"/>
										</div>
									</div>
										
									<span class="btn-add" id='addmoney' style="position:absolute ;margin-left: 10px;margin-top: -20px"></span>
									<div class="bottom-con" id="paymoney" style="height: 55px">
									</div>
								</div>
								<div class="bottom" style="margin-top: -20px">
									<label class="am-checkbox">
										<input type="radio" name="othertype" value="3" style="display: none;">挂账
									</label>
								</div>
							</div>
						</div>
					</div>
					<div class="sec-4">
						<label>操作员：</label>
						<input type="text" value="${fld:staff_name}" readonly="readonly">
						<label>操作日期：</label>
						<input type="text" value="${def:date}" readonly="readonly">
						<label>收款人员：</label>
						<input type="text" value="${fld:staff_name}" readonly="readonly">
						<label>收款人日期：</label>
						<input type="text" value="${def:date}" readonly="readonly">
					</div>
				</div>
     </form>
    </body>
<script type="text/javascript">
$(function(){
	//判断该登录人是否有收款权限
	if(parseInt("${fld:skillscopenum}")>0){
		$("#save_btn").show();
	}
	//页面点击事件
	$(document).click(function(){ 
		$(".error").html("");
	}); 
	searchSelectInit($("#storage_id,#moneytype"));	
	searchSelectInit($("#goodsname"),"240px");
	//查询商品
	$("#goodsname").change(function(){
		$("#findtype").val("1");
		$("#searchgptuid").val("");
		if($("#storage_id").val()==""){
			ccms.dialog.notice("请选择仓库！", 2000);
			return false;
		}
		var goodsname = $(this).val();
		if(goodsname!=""){
			var url = "${def:actionroot}/querygoods?searchgptuid="+goodsname;
			ajaxCall(url,{
				method:"get",
				progress:true,
				dataType:"script",
				success:function(){	
				}
			});
		}
		$("#goodsname").val("").trigger("change");
	});
	//查询会员
	$("#cardcode").blur(function(){
		$("#findtype").val("2");
		if($(this).val()!=""){
			ccms.dialog.open({url : "${def:context}/action/project/fitness/util/querycardcodelist/crud?pickcustname="
					+$(this).val()+"&objid=cardcode&random_number="+Math.random()});
		}else{
			$("#mobile,#custname,#moneygift,#moneycash").val("");
		}
	})
	ccms.util.renderCheckbox("selectAll");
	ccms.util.renderCheckbox("staff_price");
	ccms.util.renderRadio("othertype");
	ccms.util.renderRadio("othermoney");
	//全选
	$("#selectAll").unbind().on("ifClicked",function(){    //点击事件未选中
		 if( $(this).prop("checked") ){// 
			$('input[name=gptuidcheckbox]').iCheck('uncheck');
		 }else{
			$('input[name=gptuidcheckbox]').iCheck('check');  //
		 }
	});

	//付款方式切换
	$("input[name=othertype]").unbind().on("ifClicked",function(){  
		 if($(this).val()=="1"){
			 $("input[name=othermoney]").iCheck('disable');
		 }else if($(this).val()=="2"){
			 $("#paymoney").html("");
			 $("input[name=othermoney]").iCheck('enable');
		 }else if($(this).val()=="3"){
			 $("#paymoney").html("");
			 $("input[name=othermoney]").iCheck('disable');
		 }
	});
	
	//员工价正常价
	$("#staff_price").unbind().on("ifClicked",function(){ 
		if( $(this).prop("checked") ){// 
			$("#staff_type").val("0");
		}else{
			$("#staff_type").val("1");
		}
		calculate();
	});
	//仓库
	$("#storage_id").change(function(){
		$("#goodsname").html("<option value=''>全部商品</option>");
		$("#goodsname").selectpicker("refresh");
		$("#goodsname").selectpicker("render");
		$("#goodslist").html("");
		$("#total").val("0");
		if($(this).val()!=""){
			var url = "${def:actionroot}/querygoodprice?storage_id="+$(this).val();
			ajaxCall(url,{
				method:"get",
			   	progress: true,
			   	dataType: "script",
				success:function(data){
				}
			});
		}
	})
	//删除
	$(".btn-remove").click(function(){
		$("input[name='gptuidcheckbox']:checkbox").each(function(){ 
			 if( $(this).prop("checked") ){
				$(this).parent().parent().parent().remove();
			 }
		});
		//重新计算总计金额
		calculate();
	})

   $("#addmoney").click(function(){
	   	var moneytype = $("#moneytype").val();
	   	var moneytypetext = $("#moneytype option:selected").text();
	   	var money = $("#money").val();
	   	if(moneytype==""){
	   		ccms.dialog.notice("请选择支付方式！", 2000);
	   	}else if(money==""){
	   		ccms.dialog.notice("请输入金额！", 2000);
	   	}else{
	   		var count = 0;
			$("input[name='paytypemoney']").each(function(j,item){
				   if($(item).attr("code")==moneytype)count++;
			});
			if(count==0){
				$("#paymoney").append("<div class='num'>"+moneytypetext+"："+money+"元<input type='hidden' value='"+money
						+"' code='"+moneytype+"'  name='paytypemoney'/><span class='btn-remove' onclick=delhour(this)></span></div>");
				$("#moneytype,#money").val("");
				$("#moneytype").selectpicker("refresh");
				$("#moneytype").selectpicker("render");
			}else
				ccms.dialog.notice(moneytypetext+"已存在！", 2000);
	   	}
  });
	//购买
	$("#save_btn").click(function(){
		//判断当前登录人是否有收款权限
		if(parseInt("${fld:skillscopenum}")==0){
			ccms.dialog.notice("该登录人没有收款权限！", 2000);
			return false;
		}
		if(Number($("#total").val())<=0){
			ccms.dialog.notice("请购买商品在进行付款！", 2000);
			return false;
		}
		if($("#custcode").val()==""){
			ccms.dialog.notice("请输入卡号！", 2000);
			return false;
		}
		var goodcount = 0;
		$("input[name=gptuid]").each(function(){
			var url = "${def:actionroot}/querygoodquantity?gptuid="+$(this).val()+"&goodid="+$(this).attr("code");
			ajaxCall(url,{
				method:"get",
				progress:true,
				dataType:"json",
				success:function(data){
					if(goodcount==0){
						var num = $("#"+data.gptuid+"num").val();
						if(parseInt(num)>data.quantity){
							goodcount = 1;
							ccms.dialog.notice("库存不足，"+data.goods_name+"最大购买数量为"+data.quantity+"！", 2000);
						}
					}
				}
			});
		})
		if(getCheckboxValue("othertype")=="1"){
		   var moneydetail = "";
			//获取所有支付类型option
			$("#moneytype option").each(function(){  
				if($(this).val()!=""){
					moneydetail+=($("input[name=paytypemoney][code="+$(this).val()+"]").val()+";");
				}
				moneydetail = moneydetail.replace("undefined", "0");
			});
			//明细
			$("#pay_detail").val(moneydetail);
			//获取所有退费金额
			var paymoney = 0;
			$("input[name='paytypemoney']").each(function(j,item){
				paymoney+=Number(item.value);
			});
			if(Number($("#total").val())!=paymoney){
				ccms.dialog.alert("实收金额与支付金额不相同，请确认！");
				return false;
			}
			insert();
		}else{
			insert();
		}
	});
	
	$("#money").blur(function(){
		var money = $(this).val();
		if(isNaN(money)){
			money = 0;
		}
		money = Number(money).toFixed(2);
		$(this).val(money <0 ? 0 : money);
	});
});
function serachgoods(){
	ccms.dialog.open({url : "${def:context}/action/project/fitness/util/querygoodslist/crud?storage_id="
		+$("#storage_id").val()+"&goodsname="+$("#goodsname").val()+"&objid=searchgptuid&random_number="+Math.random(), height:650});
}

function insert(){
	var url = "${def:context}${def:actionroot}/insert";
	ajaxCall(url,{
	   	method: "post",
	   	form:"goodsForm",
	   	progress: true,
	   	dataType: "script",
	   	success: function() {
		}
	});
}

//查询商品回调
function pickcustCallback(){
	if($("#findtype").val()=="1"){
		var url = "${def:actionroot}/querygoods?searchgptuid="+$("#searchgptuid").val();
		ajaxCall(url,{
			method:"get",
			progress:true,
			dataType:"script",
			success:function(){	
			}
		});
	}else if($("#findtype").val()=="2"){
		var url = "${def:actionroot}/querycustmoney?cardcode="+$("#cardcode").val();
		ajaxCall(url,{
			method:"get",
			progress:true,
			dataType:"script",
			success:function(){	
			}
		});
	}
}
function delhour(val){
	$(val).parent().remove();
}

function calculate(){
	var money = 0;
	var drinkdiscount = Number($("#drinkdiscount").val());
	$("input[name='gptuidcheckbox']:checkbox").each(function(){ 
		var price = 0;
		//1员工价 
		if($("#staff_type").val()=="1"){
			price = $("#"+$(this).val()+"staff_price").val();
		}else{
			price = $("#"+$(this).val()+"price").val();
		}
		$("#"+$(this).val()+"pricetd").html(price);
		money+=Number($("#"+$(this).val()+"num").val()*price);
		$("#price").val(price);
		$("#"+$(this).val()+"formprice").val(price);
		$("#"+$(this).val()+"drinkdiscount").html(drinkdiscount*100);
		$("#"+$(this).val()+"money").html(Number($("#"+$(this).val()+"num").val()*price*drinkdiscount).toFixed(2));
		$("#"+$(this).val()+"tdmoney").val(Number($("#"+$(this).val()+"num").val()*price*drinkdiscount).toFixed(2));
	});
	$("#total").val((money*drinkdiscount).toFixed(2));
	$("#ystotal").val(money.toFixed(2));
}
//增加数量
function addNum(id){
	var num=$('#'+id).val();
	$('#'+id).val(++num);
	calculate();
}
//减少数量
function reduceNum(id){
	var num=$('#'+id).val();
	if(num>1){
		$('#'+id).val(--num);
		calculate();
	}else{
		ccms.dialog.alert("已经是最小数量");
	}
}
</script>
</html>
